!function($,data){AW.Rules=Backbone.Model.extend({initialize:function(){var app=this,ruleOptions=[];this.get("rawRuleOptions")&&_.each(this.get("rawRuleOptions"),function(rawRuleGroup){var group=new AW.RuleGroup(app),rules=[];_.each(rawRuleGroup,function(rawRule){var rule=new AW.Rule(group);rule.set("name",rawRule.name),rule.resetOptions(),rule.set("compare",rawRule.compare),rule.set("value",rawRule.value),rawRule.selected&&rule.set("selected",rawRule.selected),rules.push(rule)}),group.set("rules",rules),ruleOptions.push(group)}),this.set("ruleOptions",ruleOptions),this.resetAvailableRules()},defaults:function(){return{allRules:{},availableRules:{},ruleOptions:[]}},resetAvailableRules:function(){var trigger=AW.workflow.get("trigger");this.set("availableRules",_.filter(this.get("allRules"),function(rule){return trigger&&trigger.supplied_data_items.indexOf(rule.data_item)!==-1}));var groupedRules={};_.each(this.get("availableRules"),function(rule){groupedRules[rule.group]||(groupedRules[rule.group]=[]),groupedRules[rule.group].push(rule)}),this.set("groupedRules",groupedRules)},isRuleAvailable:function(rule_name){var availableRules=AW.rules.get("availableRules"),names=_.pluck(availableRules,"name");return _.indexOf(names,rule_name)!==-1},clearIncompatibleRules:function(){var rulesToRemove=[];_.each(AW.rules.get("ruleOptions"),function(ruleGroup){_.each(ruleGroup.get("rules"),function(rule){rule&&!AW.rules.isRuleAvailable(rule.get("name"))&&rulesToRemove.push(rule)})}),_.each(rulesToRemove,function(rule){rule.clear()})},createGroup:function(){var groups=this.get("ruleOptions"),group=new AW.RuleGroup(this);return group.createRule(),groups.push(group),this.set("ruleOptions",groups),this.trigger("ruleGroupChange"),group},removeGroup:function(id){var groups=this.get("ruleOptions"),index=groups.map(function(group){return group.id}).indexOf(id);groups[index].destroy(),groups.splice(index,1),this.set("ruleOptions",groups),this.trigger("ruleGroupChange")}}),AW.Rule=Backbone.Model.extend({initialize:function(group){this.set("id",_.uniqueId("rule_")),this.set("group",group),this.resetOptions()},getRuleObject:function(){return data.allRules[this.get("name")]},resetOptions:function(){var name=this.get("name"),ruleObject=this.getRuleObject();return name?this.set("object",ruleObject):this.set("object",{}),this.set("compare",!1),this.set("value",!1),this.loadSelectOptions(),this},loadSelectOptions:function(){var self=this,ruleObject=this.getRuleObject();return!ruleObject||"select"!==ruleObject.type||ruleObject.select_choices?this:(self.set("isValueLoading",!0),$.getJSON(ajaxurl,{action:"aw_get_rule_select_choices",rule_name:ruleObject.name},function(response){response.success&&(ruleObject.select_choices=response.data.select_choices,self.set("isValueLoading",!1),self.set("object",ruleObject),self.trigger("optionsLoaded"))}),this)},clear:function(){var group=this.get("group");group.removeRule(this.id)},destroy:function(){this.trigger("destroy")}}),AW.RuleGroup=Backbone.Model.extend({initialize:function(app){this.set("id",_.uniqueId("rule_group_")),this.set("app",app),this.set("rules",[])},createRule:function(){var rules=this.get("rules"),rule=new AW.Rule(this);return rules.push(rule),this.set("rules",rules),rule},removeRule:function(id){var rules=this.get("rules"),index=rules.map(function(rule){return rule.id}).indexOf(id);rules.length>1?(rules[index].destroy(),rules.splice(index,1),this.set("rules",rules)):(rules[index].destroy(),this.clear())},clear:function(){var app=this.get("app");app.removeGroup(this.id)},destroy:function(){this.trigger("destroy")}}),AW.RuleView=Backbone.View.extend({className:"aw-rule-row",template:wp.template("aw-rule"),events:{"change .js-rule-select":"updateName","change .js-rule-compare-field":"updateCompare","change .js-rule-value-field":"updateValue","click .js-remove-rule":"clear"},initialize:function(){this.listenTo(this.model,"change:id",this.render),this.listenTo(this.model,"change:group",this.render),this.listenTo(this.model,"optionsLoaded",this.render),this.listenTo(this.model,"destroy",this.remove)},render:function(){var self=this;return self.$el.html(self.template({rule:self.model.toJSON(),groupedRules:AW.rules.get("groupedRules"),fieldNameBase:self.getFieldNameBase()})),self.$el.find(".js-rule-select").val(self.model.get("name")),self.model.get("compare")&&self.$el.find(".js-rule-compare-field").val(self.model.get("compare")),self.model.get("value")&&self.$el.find(".js-rule-value-field").val(self.model.get("value")),self.model.get("selected")&&self.$el.find(".js-rule-value-field").attr("data-selected",self.model.get("selected")),AW.initEnhancedSelects(),this},updateName:function(e){this.model.set("name",e.target.value).resetOptions(),this.render()},updateCompare:function(e){this.model.set("compare",e.target.value)},updateValue:function(e){this.model.set("value",$(e.target).val())},getFieldNameBase:function(){var id=this.model.get("id"),group=this.model.get("group");return"aw_workflow_data[rule_options]["+group.id+"]["+id+"]"},clear:function(){this.model.clear()}}),AW.RuleGroupView=Backbone.View.extend({className:"aw-rule-group",template:wp.template("aw-rule-group"),events:{"click .js-add-rule":"addRule"},initialize:function(){this.listenTo(this.model,"refreshRules",this.refreshRules),this.listenTo(this.model,"change:id",this.refreshRules),this.listenTo(this.model,"destroy",this.remove)},render:function(){var self=this;return self.model.get("rules").length&&(self.$el.html(self.template(self.model.toJSON())),self.$el.find(".rules").empty(),_.each(self.model.get("rules"),function(rule){var view=new AW.RuleView({model:rule});self.$el.find(".rules").append(view.render().el)})),AW.initEnhancedSelects(),this},addRule:function(){var model=this.model.createRule(),view=new AW.RuleView({model:model});return this.$el.find(".rules").append(view.render().el),AW.initEnhancedSelects(),this},refreshRules:function(){_.each(this.model.get("rules"),function(rule){rule.trigger("change:group")})},clear:function(){this.undelegateEvents(),this.model.clear()}}),AW.RulesView=Backbone.View.extend({el:$("#aw-rules-container"),$meta_box:$("#aw_rules_box"),template:wp.template("aw-rules-container"),events:{"click .js-add-rule-group":"addGroup"},initialize:function(){this.listenTo(this.model,"ruleGroupChange",this.maybeShowEmptyMessage),this.listenTo(this.model,"change:groupedRules",this.refreshRules),this.render()},render:function(){var self=this,trigger=AW.workflow.get("trigger");self.$el.html(self.template({app:self,trigger:trigger}));var $groups=self.$el.find(".aw-rule-groups"),groups=self.model.get("ruleOptions");return groups.length?_.each(groups,function(group){var view=new AW.RuleGroupView({model:group});$groups.append(view.render().el)}):this.addEmptyMessage(),AW.initEnhancedSelects(),this},addGroup:function(){var model=this.model.createGroup(),view=new AW.RuleGroupView({model:model});return this.$el.find(".aw-rule-groups").append(view.render().el),AW.initEnhancedSelects(),this},maybeShowEmptyMessage:function(){this.model.get("ruleOptions").length?this.removeEmptyMessage():this.addEmptyMessage()},addEmptyMessage:function(){this.$el.find(".aw-rule-groups").html(wp.template("aw-rule-groups-empty"))},removeEmptyMessage:function(){this.$el.find(".aw-rules-empty-message").remove()},refreshRules:function(){_.each(this.model.get("ruleOptions"),function(group){group.trigger("refreshRules")})}}),$(document).ready(function(){AW.rules=new AW.Rules({allRules:data.allRules,rawRuleOptions:data.ruleOptions}),AW.rulesView=new AW.RulesView({model:AW.rules})})}(jQuery,automatewooWorkflowLocalizeScript);